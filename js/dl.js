(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.pv_dl = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var download_text, log, second_to_time;

  log = require('../log');

  second_to_time = function(s) {
    var h, m, ns, o;
    ns = function(n) {
      if (n < 10) {
        return '0' + n;
      } else {
        return '' + n;
      }
    };
    m = Math.floor(s / 60);
    s = s - m * 60;
    h = Math.floor(m / 60);
    m = m - h * 60;
    s = Math.floor(s);
    o = (ns(m)) + ":" + (ns(s));
    if (h > 0) {
      o = (ns(h)) + ":" + o;
    }
    return o;
  };

  download_text = function(filename, text) {
    var b, file_url;
    b = new Blob([text], {
      type: 'text/plain'
    });
    file_url = URL.createObjectURL(b);
    return chrome.downloads.download({
      url: file_url,
      filename: filename,
      conflictAction: 'uniquify'
    }, function(download_id) {
      return log.d("bg/util: download_text: id " + download_id + ", filename " + filename + ", URL " + file_url);
    });
  };

  module.exports = {
    second_to_time: second_to_time,
    download_text: download_text
  };

}).call(this);



},{"../log":4}],2:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  module.exports = {
    check_init_max_wait_s: 20,
    check_video_play_count_s: 5,
    flush_delta_s: 60,
    flush_reserve_s: 120,
    flush_wait_s: 1,
    auto_flush_reserve_s: 5,
    merge_ffmpeg_bin: 'ffmpeg',
    dl_prefix: 'parse_v-crx-dl'
  };

}).call(this);



},{}],3:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var config, create_dl_ui, create_get_addr_ui, dl_init, get_all_info, log, merge, msg, render_one_tab, render_page;

  log = require('./log');

  msg = require('./msg');

  config = require('./config');

  merge = require('./p_dl/merge');

  get_all_info = function() {
    return msg.send(msg.t.get_all, null, function(info) {
      log.d("dl: get_all: result = " + (JSON.stringify(info)));
      return render_page(info);
    });
  };

  render_page = function(info) {
    var div, i, results, v;
    if (info === null) {
      return;
    }
    $('#main_place_holder').remove();
    div = $('#dl_main_ui');
    results = [];
    for (i in info) {
      v = info[i];
      results.push(render_one_tab(i, v, div));
    }
    return results;
  };

  render_one_tab = function(tab_id, one, host) {
    var a, before, div, f, filename, h, i, j, len, li, ol, p, time_s;
    div = $("<div id=\"tab_id_" + tab_id + "\" ></div>");
    host.append(div);
    h = $('<h2></h2>');
    h.text("id " + tab_id + " : " + one.title);
    div.append(h);
    p = $('<p></p>');
    p.text("[" + one.site + "] " + one.url);
    div.append(p);
    h = $('<h3></h3>');
    h.text("视频: " + one.title_video + "_" + one.title_sub + " [ " + one.size + " ] 时长 " + (Math.round(one.max_time_s / 60)) + " 分钟 (" + one.max_time_s + " 秒) ");
    div.append(h);
    f = one.video[one.size].file;
    p = $('<p></p>');
    p.text("文件列表 (共 " + f.length + " 个分段)");
    div.append(p);
    ol = $('<ol></ol>');
    div.append(ol);
    for (j = 0, len = f.length; j < len; j++) {
      i = f[j];
      li = $('<li></li>');
      ol.append(li);
      time_s = i.time_s, before = i.before, filename = i.filename;
      p = $('<p></p>');
      p.text("[ " + (Math.round(time_s / 60)) + " 分钟 (" + time_s + " 秒) ] " + filename);
      li.append(p);
      a = $('<a></a>');
      a.text(before);
      a.attr('href', before);
      li.append(a);
    }
    create_get_addr_ui(div, one, tab_id);
    return create_dl_ui(div, one, tab_id);
  };

  create_dl_ui = function(div, info, tab_id) {
    var b, count, dl_dir_prefix, download_next, download_one_file, f, get_one_final_url, i_max, ll, pre, start_download;
    div.append($('<h3>简单下载功能</h3>'));
    b = $('<button type="button" >下载全部分段</button>');
    div.append(b);
    pre = $('<pre></pre>');
    div.append(pre);
    ll = function(text) {
      return pre.text(pre.text() + ':: ' + text + '\n');
    };
    dl_dir_prefix = config.dl_prefix;
    f = info.video[info.size].file;
    count = {
      i: 0
    };
    i_max = f.length;
    b.on('click', function() {
      ll("开始下载共 " + i_max + " 个文件 .. . ");
      merge.gen_merge_script(info, config.dl_prefix);
      return start_download();
    });
    start_download = function() {
      if (count.i >= i_max) {
        return ll("所有文件下载完毕 ! ");
      }
      ll("下载第 " + (count.i + 1) + " 个文件 ");
      return get_one_final_url(tab_id, f[count.i]);
    };
    get_one_final_url = function(tab_id, raw) {
      return msg.send(msg.t.get_one_file, {
        tab_id: tab_id,
        raw: raw
      }, function(result) {
        var file_path;
        log.d(" dl: get_one_final_url: result = " + (JSON.stringify(result)));
        file_path = dl_dir_prefix + '/' + raw.filename;
        return download_one_file(result.url, file_path);
      });
    };
    download_one_file = function(file_url, file_path) {
      return chrome.downloads.download({
        url: file_url,
        filename: file_path,
        conflictAction: 'uniquify'
      }, function(download_id) {
        ll("文件 " + file_path + " 已开始下载, 等待下载完成 .. . ");
        log.d("download start: id == " + info.id + ", file_path = " + file_path + ", url == " + file_url + " ");
        return chrome.downloads.onChanged.addListener(function(info) {
          if (info.id === download_id) {
            log.d("download changed: id == " + info.id + ", state == " + (JSON.stringify(info.state)) + " ");
            if ((info.state != null) && (info.state.current === 'complete')) {
              ll("[ OK ] 文件 " + file_path + " 下载完成 ! ");
              return download_next();
            }
          }
        });
      });
    };
    return download_next = function() {
      count.i += 1;
      return start_download();
    };
  };

  create_get_addr_ui = function(div, info, tab_id) {
    var b, count, d, f, get_next, get_one_final_url, i_max, start_get, t;
    b = $('<button type="button" >获取全部文件下载地址</button>');
    div.append(b);
    t = $('<textarea></textarea>');
    d = $('<div></div>');
    d.append(t);
    div.append(d);
    f = info.video[info.size].file;
    count = {
      i: 0,
      first_result: true
    };
    i_max = f.length;
    b.on('click', function() {
      t.text('正在获取 .. . ');
      return start_get();
    });
    start_get = function() {
      if (count.i < i_max) {
        return get_one_final_url(tab_id, f[count.i]);
      }
    };
    get_one_final_url = function(tab_id, raw) {
      return msg.send(msg.t.get_one_file, {
        tab_id: tab_id,
        raw: raw
      }, function(result) {
        log.d("dl: get_one_final_url: result = " + (JSON.stringify(result)));
        if (count.first_result) {
          count.first_result = false;
          t.text('');
        }
        t.text("" + (t.text()) + result.url + "\n");
        return get_next();
      });
    };
    return get_next = function() {
      count.i += 1;
      return start_get();
    };
  };

  dl_init = function() {
    log.d('dl: init ');
    return get_all_info();
  };

  dl_init();

}).call(this);



},{"./config":2,"./log":4,"./msg":5,"./p_dl/merge":7}],4:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var log_p;

  log_p = function(text) {
    return console.log(module.exports.prefix + text);
  };

  module.exports = {
    prefix: 'parse_v-crx: ',
    d: function(text) {
      return log_p('DEBUG: ' + text);
    },
    c: function(text) {
      return log_p('content script: ' + text);
    }
  };

}).call(this);



},{}],5:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var msg_type_check_support, msg_type_flush_done, msg_type_found, msg_type_get_all, msg_type_get_info, msg_type_get_one_file, msg_type_get_state, msg_type_playing, msg_type_popup_refresh, msg_type_set_time, msg_type_start_flush, msg_version, parse_v_mark, send_msg, send_to_content, set_on_msg;

  parse_v_mark = 'uuid=ec9680e6-da5e-4971-ac5f-25d971bf6366';

  msg_version = '0.1.0-1';

  msg_type_found = 'content_found';

  msg_type_playing = 'content_playing';

  msg_type_get_info = 'content_get_info';

  msg_type_check_support = 'content_check_support';

  msg_type_set_time = 'content_set_time';

  msg_type_get_state = 'popup_get_state';

  msg_type_start_flush = 'popup_start_flush';

  msg_type_flush_done = 'popup_flush_done';

  msg_type_popup_refresh = 'popup_refresh';

  msg_type_get_all = 'dl_get_all';

  msg_type_get_one_file = 'dl_get_one_file';

  set_on_msg = function(callback) {
    return chrome.runtime.onMessage.addListener(function(msg, sender, send_res) {
      var e;
      try {
        if (!((msg.mark === parse_v_mark) && (msg.version === msg_version))) {
          return;
        }
      } catch (error) {
        e = error;
        return;
      }
      return callback({
        mark: msg.mark,
        version: msg.version,
        type: msg.type,
        data: msg.data,
        sender: sender,
        callback: send_res
      });
    });
  };

  send_msg = function(msg_type, data, callback) {
    var msg;
    msg = {
      mark: parse_v_mark,
      version: msg_version,
      type: msg_type,
      data: data
    };
    return chrome.runtime.sendMessage(null, msg, callback);
  };

  send_to_content = function(msg_type, data, callback, tab_id) {
    var msg;
    msg = {
      mark: parse_v_mark,
      version: msg_version,
      type: msg_type,
      data: data
    };
    return chrome.tabs.sendMessage(tab_id, msg, callback);
  };

  module.exports = {
    mark: parse_v_mark,
    version: msg_version,
    t: {
      found: msg_type_found,
      playing: msg_type_playing,
      get_info: msg_type_get_info,
      check_support: msg_type_check_support,
      set_time: msg_type_set_time,
      get_state: msg_type_get_state,
      start_flush: msg_type_start_flush,
      flush_done: msg_type_flush_done,
      popup_refresh: msg_type_popup_refresh,
      get_all: msg_type_get_all,
      get_one_file: msg_type_get_one_file
    },
    on: set_on_msg,
    send: send_msg,
    send_to_content: send_to_content
  };

}).call(this);



},{}],6:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var config, make_ffmpeg_merge_sh;

  config = require('../config');

  make_ffmpeg_merge_sh = function(file_list, output_file, sh_filename) {
    var ffmpeg, o, output;
    output = [];
    o = function(line) {
      return output.push(line);
    };
    o('@echo on');
    o('chcp 65001');
    o('');
    ffmpeg = config.merge_ffmpeg_bin;
    o(ffmpeg + " -i \"concat:" + (file_list.join('|')) + "\" -c copy " + output_file);
    o('');
    o('pause');
    o('cmd');
    o('');
    o(":: end " + sh_filename + ": ffmpeg merge bat, generated by parse_v-crx at " + (new Date()));
    o('');
    return output.join('\r\n') + '\r\n';
  };

  module.exports = make_ffmpeg_merge_sh;

}).call(this);



},{"../config":2}],7:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var gen_merge_script, log, merge_bat, merge_sh, util;

  log = require('../log');

  util = require('../bg/util');

  merge_sh = require('./merge.sh');

  merge_bat = require('./merge.bat');

  gen_merge_script = function(info, prefix) {
    var file_list, i, main_name, output_file, raw_list;
    raw_list = info.video[info.size].file;
    main_name = raw_list[0].filename.split('.')[0];
    file_list = (function() {
      var j, len, results;
      results = [];
      for (j = 0, len = raw_list.length; j < len; j++) {
        i = raw_list[j];
        results.push(i.filename);
      }
      return results;
    })();
    output_file = main_name + ".out.mp4";
    return chrome.runtime.getPlatformInfo(function(p) {
      var make_merge, script_name, script_text;
      log.d("p_dl/merge: os " + p.os);
      if (p.os === 'win') {
        script_name = "合并." + main_name + ".parse_v-crx.bat";
        make_merge = merge_bat;
      } else {
        script_name = "merge." + main_name + ".parse_v-crx.sh";
        make_merge = merge_sh;
      }
      script_text = make_merge(file_list, output_file, script_name);
      util.download_text(prefix + '/' + script_name, script_text);
      return log.d("p_dl/merge: gen_merge_script: done. " + script_name);
    });
  };

  module.exports = {
    gen_merge_script: gen_merge_script
  };

}).call(this);



},{"../bg/util":1,"../log":4,"./merge.bat":6,"./merge.sh":8}],8:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var config, make_ffmpeg_merge_sh;

  config = require('../config');

  make_ffmpeg_merge_sh = function(file_list, output_file, sh_filename) {
    var ffmpeg, i, j, len, o, output;
    output = [];
    o = function(line) {
      return output.push(line);
    };
    o('#!/bin/sh');
    o("# " + sh_filename + ": ffmpeg merge sh, generated by parse_v-crx at " + (new Date()));
    o('');
    o('file_list="\\');
    for (j = 0, len = file_list.length; j < len; j++) {
      i = file_list[j];
      o(i + "\\");
      o('|\\');
    }
    output.pop();
    o('"');
    o("output_file=\"" + output_file + "\"");
    o('');
    ffmpeg = config.merge_ffmpeg_bin;
    o("echo \"-> " + ffmpeg + " -i \\\"concat:${file_list}\\\" -c copy ${output_file}\"");
    o(ffmpeg + " -i \"concat:${file_list}\" -c copy ${output_file}");
    o('');
    o("# end " + sh_filename);
    o('');
    return output.join('\n') + '\n';
  };

  module.exports = make_ffmpeg_merge_sh;

}).call(this);



},{"../config":2}]},{},[3])(3)
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJkaXN0L3MvYmcvdXRpbC5qcyIsImRpc3Qvcy9jb25maWcuanMiLCJkaXN0L3MvZGwuanMiLCJkaXN0L3MvbG9nLmpzIiwiZGlzdC9zL21zZy5qcyIsImRpc3Qvcy9wX2RsL21lcmdlLmJhdC5qcyIsImRpc3Qvcy9wX2RsL21lcmdlLmpzIiwiZGlzdC9zL3BfZGwvbWVyZ2Uuc2guanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbERBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDaEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDM0xBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDbEdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDL0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDakRBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS4xMi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBkb3dubG9hZF90ZXh0LCBsb2csIHNlY29uZF90b190aW1lO1xuXG4gIGxvZyA9IHJlcXVpcmUoJy4uL2xvZycpO1xuXG4gIHNlY29uZF90b190aW1lID0gZnVuY3Rpb24ocykge1xuICAgIHZhciBoLCBtLCBucywgbztcbiAgICBucyA9IGZ1bmN0aW9uKG4pIHtcbiAgICAgIGlmIChuIDwgMTApIHtcbiAgICAgICAgcmV0dXJuICcwJyArIG47XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gJycgKyBuO1xuICAgICAgfVxuICAgIH07XG4gICAgbSA9IE1hdGguZmxvb3IocyAvIDYwKTtcbiAgICBzID0gcyAtIG0gKiA2MDtcbiAgICBoID0gTWF0aC5mbG9vcihtIC8gNjApO1xuICAgIG0gPSBtIC0gaCAqIDYwO1xuICAgIHMgPSBNYXRoLmZsb29yKHMpO1xuICAgIG8gPSAobnMobSkpICsgXCI6XCIgKyAobnMocykpO1xuICAgIGlmIChoID4gMCkge1xuICAgICAgbyA9IChucyhoKSkgKyBcIjpcIiArIG87XG4gICAgfVxuICAgIHJldHVybiBvO1xuICB9O1xuXG4gIGRvd25sb2FkX3RleHQgPSBmdW5jdGlvbihmaWxlbmFtZSwgdGV4dCkge1xuICAgIHZhciBiLCBmaWxlX3VybDtcbiAgICBiID0gbmV3IEJsb2IoW3RleHRdLCB7XG4gICAgICB0eXBlOiAndGV4dC9wbGFpbidcbiAgICB9KTtcbiAgICBmaWxlX3VybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYik7XG4gICAgcmV0dXJuIGNocm9tZS5kb3dubG9hZHMuZG93bmxvYWQoe1xuICAgICAgdXJsOiBmaWxlX3VybCxcbiAgICAgIGZpbGVuYW1lOiBmaWxlbmFtZSxcbiAgICAgIGNvbmZsaWN0QWN0aW9uOiAndW5pcXVpZnknXG4gICAgfSwgZnVuY3Rpb24oZG93bmxvYWRfaWQpIHtcbiAgICAgIHJldHVybiBsb2cuZChcImJnL3V0aWw6IGRvd25sb2FkX3RleHQ6IGlkIFwiICsgZG93bmxvYWRfaWQgKyBcIiwgZmlsZW5hbWUgXCIgKyBmaWxlbmFtZSArIFwiLCBVUkwgXCIgKyBmaWxlX3VybCk7XG4gICAgfSk7XG4gIH07XG5cbiAgbW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgc2Vjb25kX3RvX3RpbWU6IHNlY29uZF90b190aW1lLFxuICAgIGRvd25sb2FkX3RleHQ6IGRvd25sb2FkX3RleHRcbiAgfTtcblxufSkuY2FsbCh0aGlzKTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9dXRpbC5qcy5tYXBcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS4xMi4zXG4oZnVuY3Rpb24oKSB7XG4gIG1vZHVsZS5leHBvcnRzID0ge1xuICAgIGNoZWNrX2luaXRfbWF4X3dhaXRfczogMjAsXG4gICAgY2hlY2tfdmlkZW9fcGxheV9jb3VudF9zOiA1LFxuICAgIGZsdXNoX2RlbHRhX3M6IDYwLFxuICAgIGZsdXNoX3Jlc2VydmVfczogMTIwLFxuICAgIGZsdXNoX3dhaXRfczogMSxcbiAgICBhdXRvX2ZsdXNoX3Jlc2VydmVfczogNSxcbiAgICBtZXJnZV9mZm1wZWdfYmluOiAnZmZtcGVnJyxcbiAgICBkbF9wcmVmaXg6ICdwYXJzZV92LWNyeC1kbCdcbiAgfTtcblxufSkuY2FsbCh0aGlzKTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlnLmpzLm1hcFxuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjEyLjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIGNvbmZpZywgY3JlYXRlX2RsX3VpLCBjcmVhdGVfZ2V0X2FkZHJfdWksIGRsX2luaXQsIGdldF9hbGxfaW5mbywgbG9nLCBtZXJnZSwgbXNnLCByZW5kZXJfb25lX3RhYiwgcmVuZGVyX3BhZ2U7XG5cbiAgbG9nID0gcmVxdWlyZSgnLi9sb2cnKTtcblxuICBtc2cgPSByZXF1aXJlKCcuL21zZycpO1xuXG4gIGNvbmZpZyA9IHJlcXVpcmUoJy4vY29uZmlnJyk7XG5cbiAgbWVyZ2UgPSByZXF1aXJlKCcuL3BfZGwvbWVyZ2UnKTtcblxuICBnZXRfYWxsX2luZm8gPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbXNnLnNlbmQobXNnLnQuZ2V0X2FsbCwgbnVsbCwgZnVuY3Rpb24oaW5mbykge1xuICAgICAgbG9nLmQoXCJkbDogZ2V0X2FsbDogcmVzdWx0ID0gXCIgKyAoSlNPTi5zdHJpbmdpZnkoaW5mbykpKTtcbiAgICAgIHJldHVybiByZW5kZXJfcGFnZShpbmZvKTtcbiAgICB9KTtcbiAgfTtcblxuICByZW5kZXJfcGFnZSA9IGZ1bmN0aW9uKGluZm8pIHtcbiAgICB2YXIgZGl2LCBpLCByZXN1bHRzLCB2O1xuICAgIGlmIChpbmZvID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgICQoJyNtYWluX3BsYWNlX2hvbGRlcicpLnJlbW92ZSgpO1xuICAgIGRpdiA9ICQoJyNkbF9tYWluX3VpJyk7XG4gICAgcmVzdWx0cyA9IFtdO1xuICAgIGZvciAoaSBpbiBpbmZvKSB7XG4gICAgICB2ID0gaW5mb1tpXTtcbiAgICAgIHJlc3VsdHMucHVzaChyZW5kZXJfb25lX3RhYihpLCB2LCBkaXYpKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH07XG5cbiAgcmVuZGVyX29uZV90YWIgPSBmdW5jdGlvbih0YWJfaWQsIG9uZSwgaG9zdCkge1xuICAgIHZhciBhLCBiZWZvcmUsIGRpdiwgZiwgZmlsZW5hbWUsIGgsIGksIGosIGxlbiwgbGksIG9sLCBwLCB0aW1lX3M7XG4gICAgZGl2ID0gJChcIjxkaXYgaWQ9XFxcInRhYl9pZF9cIiArIHRhYl9pZCArIFwiXFxcIiA+PC9kaXY+XCIpO1xuICAgIGhvc3QuYXBwZW5kKGRpdik7XG4gICAgaCA9ICQoJzxoMj48L2gyPicpO1xuICAgIGgudGV4dChcImlkIFwiICsgdGFiX2lkICsgXCIgOiBcIiArIG9uZS50aXRsZSk7XG4gICAgZGl2LmFwcGVuZChoKTtcbiAgICBwID0gJCgnPHA+PC9wPicpO1xuICAgIHAudGV4dChcIltcIiArIG9uZS5zaXRlICsgXCJdIFwiICsgb25lLnVybCk7XG4gICAgZGl2LmFwcGVuZChwKTtcbiAgICBoID0gJCgnPGgzPjwvaDM+Jyk7XG4gICAgaC50ZXh0KFwi6KeG6aKROiBcIiArIG9uZS50aXRsZV92aWRlbyArIFwiX1wiICsgb25lLnRpdGxlX3N1YiArIFwiIFsgXCIgKyBvbmUuc2l6ZSArIFwiIF0g5pe26ZW/IFwiICsgKE1hdGgucm91bmQob25lLm1heF90aW1lX3MgLyA2MCkpICsgXCIg5YiG6ZKfIChcIiArIG9uZS5tYXhfdGltZV9zICsgXCIg56eSKSBcIik7XG4gICAgZGl2LmFwcGVuZChoKTtcbiAgICBmID0gb25lLnZpZGVvW29uZS5zaXplXS5maWxlO1xuICAgIHAgPSAkKCc8cD48L3A+Jyk7XG4gICAgcC50ZXh0KFwi5paH5Lu25YiX6KGoICjlhbEgXCIgKyBmLmxlbmd0aCArIFwiIOS4quWIhuautSlcIik7XG4gICAgZGl2LmFwcGVuZChwKTtcbiAgICBvbCA9ICQoJzxvbD48L29sPicpO1xuICAgIGRpdi5hcHBlbmQob2wpO1xuICAgIGZvciAoaiA9IDAsIGxlbiA9IGYubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHtcbiAgICAgIGkgPSBmW2pdO1xuICAgICAgbGkgPSAkKCc8bGk+PC9saT4nKTtcbiAgICAgIG9sLmFwcGVuZChsaSk7XG4gICAgICB0aW1lX3MgPSBpLnRpbWVfcywgYmVmb3JlID0gaS5iZWZvcmUsIGZpbGVuYW1lID0gaS5maWxlbmFtZTtcbiAgICAgIHAgPSAkKCc8cD48L3A+Jyk7XG4gICAgICBwLnRleHQoXCJbIFwiICsgKE1hdGgucm91bmQodGltZV9zIC8gNjApKSArIFwiIOWIhumSnyAoXCIgKyB0aW1lX3MgKyBcIiDnp5IpIF0gXCIgKyBmaWxlbmFtZSk7XG4gICAgICBsaS5hcHBlbmQocCk7XG4gICAgICBhID0gJCgnPGE+PC9hPicpO1xuICAgICAgYS50ZXh0KGJlZm9yZSk7XG4gICAgICBhLmF0dHIoJ2hyZWYnLCBiZWZvcmUpO1xuICAgICAgbGkuYXBwZW5kKGEpO1xuICAgIH1cbiAgICBjcmVhdGVfZ2V0X2FkZHJfdWkoZGl2LCBvbmUsIHRhYl9pZCk7XG4gICAgcmV0dXJuIGNyZWF0ZV9kbF91aShkaXYsIG9uZSwgdGFiX2lkKTtcbiAgfTtcblxuICBjcmVhdGVfZGxfdWkgPSBmdW5jdGlvbihkaXYsIGluZm8sIHRhYl9pZCkge1xuICAgIHZhciBiLCBjb3VudCwgZGxfZGlyX3ByZWZpeCwgZG93bmxvYWRfbmV4dCwgZG93bmxvYWRfb25lX2ZpbGUsIGYsIGdldF9vbmVfZmluYWxfdXJsLCBpX21heCwgbGwsIHByZSwgc3RhcnRfZG93bmxvYWQ7XG4gICAgZGl2LmFwcGVuZCgkKCc8aDM+566A5Y2V5LiL6L295Yqf6IO9PC9oMz4nKSk7XG4gICAgYiA9ICQoJzxidXR0b24gdHlwZT1cImJ1dHRvblwiID7kuIvovb3lhajpg6jliIbmrrU8L2J1dHRvbj4nKTtcbiAgICBkaXYuYXBwZW5kKGIpO1xuICAgIHByZSA9ICQoJzxwcmU+PC9wcmU+Jyk7XG4gICAgZGl2LmFwcGVuZChwcmUpO1xuICAgIGxsID0gZnVuY3Rpb24odGV4dCkge1xuICAgICAgcmV0dXJuIHByZS50ZXh0KHByZS50ZXh0KCkgKyAnOjogJyArIHRleHQgKyAnXFxuJyk7XG4gICAgfTtcbiAgICBkbF9kaXJfcHJlZml4ID0gY29uZmlnLmRsX3ByZWZpeDtcbiAgICBmID0gaW5mby52aWRlb1tpbmZvLnNpemVdLmZpbGU7XG4gICAgY291bnQgPSB7XG4gICAgICBpOiAwXG4gICAgfTtcbiAgICBpX21heCA9IGYubGVuZ3RoO1xuICAgIGIub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICBsbChcIuW8gOWni+S4i+i9veWFsSBcIiArIGlfbWF4ICsgXCIg5Liq5paH5Lu2IC4uIC4gXCIpO1xuICAgICAgbWVyZ2UuZ2VuX21lcmdlX3NjcmlwdChpbmZvLCBjb25maWcuZGxfcHJlZml4KTtcbiAgICAgIHJldHVybiBzdGFydF9kb3dubG9hZCgpO1xuICAgIH0pO1xuICAgIHN0YXJ0X2Rvd25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoY291bnQuaSA+PSBpX21heCkge1xuICAgICAgICByZXR1cm4gbGwoXCLmiYDmnInmlofku7bkuIvovb3lrozmr5UgISBcIik7XG4gICAgICB9XG4gICAgICBsbChcIuS4i+i9veesrCBcIiArIChjb3VudC5pICsgMSkgKyBcIiDkuKrmlofku7YgXCIpO1xuICAgICAgcmV0dXJuIGdldF9vbmVfZmluYWxfdXJsKHRhYl9pZCwgZltjb3VudC5pXSk7XG4gICAgfTtcbiAgICBnZXRfb25lX2ZpbmFsX3VybCA9IGZ1bmN0aW9uKHRhYl9pZCwgcmF3KSB7XG4gICAgICByZXR1cm4gbXNnLnNlbmQobXNnLnQuZ2V0X29uZV9maWxlLCB7XG4gICAgICAgIHRhYl9pZDogdGFiX2lkLFxuICAgICAgICByYXc6IHJhd1xuICAgICAgfSwgZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgIHZhciBmaWxlX3BhdGg7XG4gICAgICAgIGxvZy5kKFwiIGRsOiBnZXRfb25lX2ZpbmFsX3VybDogcmVzdWx0ID0gXCIgKyAoSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkpO1xuICAgICAgICBmaWxlX3BhdGggPSBkbF9kaXJfcHJlZml4ICsgJy8nICsgcmF3LmZpbGVuYW1lO1xuICAgICAgICByZXR1cm4gZG93bmxvYWRfb25lX2ZpbGUocmVzdWx0LnVybCwgZmlsZV9wYXRoKTtcbiAgICAgIH0pO1xuICAgIH07XG4gICAgZG93bmxvYWRfb25lX2ZpbGUgPSBmdW5jdGlvbihmaWxlX3VybCwgZmlsZV9wYXRoKSB7XG4gICAgICByZXR1cm4gY2hyb21lLmRvd25sb2Fkcy5kb3dubG9hZCh7XG4gICAgICAgIHVybDogZmlsZV91cmwsXG4gICAgICAgIGZpbGVuYW1lOiBmaWxlX3BhdGgsXG4gICAgICAgIGNvbmZsaWN0QWN0aW9uOiAndW5pcXVpZnknXG4gICAgICB9LCBmdW5jdGlvbihkb3dubG9hZF9pZCkge1xuICAgICAgICBsbChcIuaWh+S7tiBcIiArIGZpbGVfcGF0aCArIFwiIOW3suW8gOWni+S4i+i9vSwg562J5b6F5LiL6L295a6M5oiQIC4uIC4gXCIpO1xuICAgICAgICBsb2cuZChcImRvd25sb2FkIHN0YXJ0OiBpZCA9PSBcIiArIGluZm8uaWQgKyBcIiwgZmlsZV9wYXRoID0gXCIgKyBmaWxlX3BhdGggKyBcIiwgdXJsID09IFwiICsgZmlsZV91cmwgKyBcIiBcIik7XG4gICAgICAgIHJldHVybiBjaHJvbWUuZG93bmxvYWRzLm9uQ2hhbmdlZC5hZGRMaXN0ZW5lcihmdW5jdGlvbihpbmZvKSB7XG4gICAgICAgICAgaWYgKGluZm8uaWQgPT09IGRvd25sb2FkX2lkKSB7XG4gICAgICAgICAgICBsb2cuZChcImRvd25sb2FkIGNoYW5nZWQ6IGlkID09IFwiICsgaW5mby5pZCArIFwiLCBzdGF0ZSA9PSBcIiArIChKU09OLnN0cmluZ2lmeShpbmZvLnN0YXRlKSkgKyBcIiBcIik7XG4gICAgICAgICAgICBpZiAoKGluZm8uc3RhdGUgIT0gbnVsbCkgJiYgKGluZm8uc3RhdGUuY3VycmVudCA9PT0gJ2NvbXBsZXRlJykpIHtcbiAgICAgICAgICAgICAgbGwoXCJbIE9LIF0g5paH5Lu2IFwiICsgZmlsZV9wYXRoICsgXCIg5LiL6L295a6M5oiQICEgXCIpO1xuICAgICAgICAgICAgICByZXR1cm4gZG93bmxvYWRfbmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9O1xuICAgIHJldHVybiBkb3dubG9hZF9uZXh0ID0gZnVuY3Rpb24oKSB7XG4gICAgICBjb3VudC5pICs9IDE7XG4gICAgICByZXR1cm4gc3RhcnRfZG93bmxvYWQoKTtcbiAgICB9O1xuICB9O1xuXG4gIGNyZWF0ZV9nZXRfYWRkcl91aSA9IGZ1bmN0aW9uKGRpdiwgaW5mbywgdGFiX2lkKSB7XG4gICAgdmFyIGIsIGNvdW50LCBkLCBmLCBnZXRfbmV4dCwgZ2V0X29uZV9maW5hbF91cmwsIGlfbWF4LCBzdGFydF9nZXQsIHQ7XG4gICAgYiA9ICQoJzxidXR0b24gdHlwZT1cImJ1dHRvblwiID7ojrflj5blhajpg6jmlofku7bkuIvovb3lnLDlnYA8L2J1dHRvbj4nKTtcbiAgICBkaXYuYXBwZW5kKGIpO1xuICAgIHQgPSAkKCc8dGV4dGFyZWE+PC90ZXh0YXJlYT4nKTtcbiAgICBkID0gJCgnPGRpdj48L2Rpdj4nKTtcbiAgICBkLmFwcGVuZCh0KTtcbiAgICBkaXYuYXBwZW5kKGQpO1xuICAgIGYgPSBpbmZvLnZpZGVvW2luZm8uc2l6ZV0uZmlsZTtcbiAgICBjb3VudCA9IHtcbiAgICAgIGk6IDAsXG4gICAgICBmaXJzdF9yZXN1bHQ6IHRydWVcbiAgICB9O1xuICAgIGlfbWF4ID0gZi5sZW5ndGg7XG4gICAgYi5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgICAgIHQudGV4dCgn5q2j5Zyo6I635Y+WIC4uIC4gJyk7XG4gICAgICByZXR1cm4gc3RhcnRfZ2V0KCk7XG4gICAgfSk7XG4gICAgc3RhcnRfZ2V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoY291bnQuaSA8IGlfbWF4KSB7XG4gICAgICAgIHJldHVybiBnZXRfb25lX2ZpbmFsX3VybCh0YWJfaWQsIGZbY291bnQuaV0pO1xuICAgICAgfVxuICAgIH07XG4gICAgZ2V0X29uZV9maW5hbF91cmwgPSBmdW5jdGlvbih0YWJfaWQsIHJhdykge1xuICAgICAgcmV0dXJuIG1zZy5zZW5kKG1zZy50LmdldF9vbmVfZmlsZSwge1xuICAgICAgICB0YWJfaWQ6IHRhYl9pZCxcbiAgICAgICAgcmF3OiByYXdcbiAgICAgIH0sIGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICBsb2cuZChcImRsOiBnZXRfb25lX2ZpbmFsX3VybDogcmVzdWx0ID0gXCIgKyAoSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkpO1xuICAgICAgICBpZiAoY291bnQuZmlyc3RfcmVzdWx0KSB7XG4gICAgICAgICAgY291bnQuZmlyc3RfcmVzdWx0ID0gZmFsc2U7XG4gICAgICAgICAgdC50ZXh0KCcnKTtcbiAgICAgICAgfVxuICAgICAgICB0LnRleHQoXCJcIiArICh0LnRleHQoKSkgKyByZXN1bHQudXJsICsgXCJcXG5cIik7XG4gICAgICAgIHJldHVybiBnZXRfbmV4dCgpO1xuICAgICAgfSk7XG4gICAgfTtcbiAgICByZXR1cm4gZ2V0X25leHQgPSBmdW5jdGlvbigpIHtcbiAgICAgIGNvdW50LmkgKz0gMTtcbiAgICAgIHJldHVybiBzdGFydF9nZXQoKTtcbiAgICB9O1xuICB9O1xuXG4gIGRsX2luaXQgPSBmdW5jdGlvbigpIHtcbiAgICBsb2cuZCgnZGw6IGluaXQgJyk7XG4gICAgcmV0dXJuIGdldF9hbGxfaW5mbygpO1xuICB9O1xuXG4gIGRsX2luaXQoKTtcblxufSkuY2FsbCh0aGlzKTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZGwuanMubWFwXG4iLCIvLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuMTIuM1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgbG9nX3A7XG5cbiAgbG9nX3AgPSBmdW5jdGlvbih0ZXh0KSB7XG4gICAgcmV0dXJuIGNvbnNvbGUubG9nKG1vZHVsZS5leHBvcnRzLnByZWZpeCArIHRleHQpO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzID0ge1xuICAgIHByZWZpeDogJ3BhcnNlX3YtY3J4OiAnLFxuICAgIGQ6IGZ1bmN0aW9uKHRleHQpIHtcbiAgICAgIHJldHVybiBsb2dfcCgnREVCVUc6ICcgKyB0ZXh0KTtcbiAgICB9LFxuICAgIGM6IGZ1bmN0aW9uKHRleHQpIHtcbiAgICAgIHJldHVybiBsb2dfcCgnY29udGVudCBzY3JpcHQ6ICcgKyB0ZXh0KTtcbiAgICB9XG4gIH07XG5cbn0pLmNhbGwodGhpcyk7XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWxvZy5qcy5tYXBcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS4xMi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBtc2dfdHlwZV9jaGVja19zdXBwb3J0LCBtc2dfdHlwZV9mbHVzaF9kb25lLCBtc2dfdHlwZV9mb3VuZCwgbXNnX3R5cGVfZ2V0X2FsbCwgbXNnX3R5cGVfZ2V0X2luZm8sIG1zZ190eXBlX2dldF9vbmVfZmlsZSwgbXNnX3R5cGVfZ2V0X3N0YXRlLCBtc2dfdHlwZV9wbGF5aW5nLCBtc2dfdHlwZV9wb3B1cF9yZWZyZXNoLCBtc2dfdHlwZV9zZXRfdGltZSwgbXNnX3R5cGVfc3RhcnRfZmx1c2gsIG1zZ192ZXJzaW9uLCBwYXJzZV92X21hcmssIHNlbmRfbXNnLCBzZW5kX3RvX2NvbnRlbnQsIHNldF9vbl9tc2c7XG5cbiAgcGFyc2Vfdl9tYXJrID0gJ3V1aWQ9ZWM5NjgwZTYtZGE1ZS00OTcxLWFjNWYtMjVkOTcxYmY2MzY2JztcblxuICBtc2dfdmVyc2lvbiA9ICcwLjEuMC0xJztcblxuICBtc2dfdHlwZV9mb3VuZCA9ICdjb250ZW50X2ZvdW5kJztcblxuICBtc2dfdHlwZV9wbGF5aW5nID0gJ2NvbnRlbnRfcGxheWluZyc7XG5cbiAgbXNnX3R5cGVfZ2V0X2luZm8gPSAnY29udGVudF9nZXRfaW5mbyc7XG5cbiAgbXNnX3R5cGVfY2hlY2tfc3VwcG9ydCA9ICdjb250ZW50X2NoZWNrX3N1cHBvcnQnO1xuXG4gIG1zZ190eXBlX3NldF90aW1lID0gJ2NvbnRlbnRfc2V0X3RpbWUnO1xuXG4gIG1zZ190eXBlX2dldF9zdGF0ZSA9ICdwb3B1cF9nZXRfc3RhdGUnO1xuXG4gIG1zZ190eXBlX3N0YXJ0X2ZsdXNoID0gJ3BvcHVwX3N0YXJ0X2ZsdXNoJztcblxuICBtc2dfdHlwZV9mbHVzaF9kb25lID0gJ3BvcHVwX2ZsdXNoX2RvbmUnO1xuXG4gIG1zZ190eXBlX3BvcHVwX3JlZnJlc2ggPSAncG9wdXBfcmVmcmVzaCc7XG5cbiAgbXNnX3R5cGVfZ2V0X2FsbCA9ICdkbF9nZXRfYWxsJztcblxuICBtc2dfdHlwZV9nZXRfb25lX2ZpbGUgPSAnZGxfZ2V0X29uZV9maWxlJztcblxuICBzZXRfb25fbXNnID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICByZXR1cm4gY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKGZ1bmN0aW9uKG1zZywgc2VuZGVyLCBzZW5kX3Jlcykge1xuICAgICAgdmFyIGU7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAoISgobXNnLm1hcmsgPT09IHBhcnNlX3ZfbWFyaykgJiYgKG1zZy52ZXJzaW9uID09PSBtc2dfdmVyc2lvbikpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBlID0gZXJyb3I7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHJldHVybiBjYWxsYmFjayh7XG4gICAgICAgIG1hcms6IG1zZy5tYXJrLFxuICAgICAgICB2ZXJzaW9uOiBtc2cudmVyc2lvbixcbiAgICAgICAgdHlwZTogbXNnLnR5cGUsXG4gICAgICAgIGRhdGE6IG1zZy5kYXRhLFxuICAgICAgICBzZW5kZXI6IHNlbmRlcixcbiAgICAgICAgY2FsbGJhY2s6IHNlbmRfcmVzXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBzZW5kX21zZyA9IGZ1bmN0aW9uKG1zZ190eXBlLCBkYXRhLCBjYWxsYmFjaykge1xuICAgIHZhciBtc2c7XG4gICAgbXNnID0ge1xuICAgICAgbWFyazogcGFyc2Vfdl9tYXJrLFxuICAgICAgdmVyc2lvbjogbXNnX3ZlcnNpb24sXG4gICAgICB0eXBlOiBtc2dfdHlwZSxcbiAgICAgIGRhdGE6IGRhdGFcbiAgICB9O1xuICAgIHJldHVybiBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZShudWxsLCBtc2csIGNhbGxiYWNrKTtcbiAgfTtcblxuICBzZW5kX3RvX2NvbnRlbnQgPSBmdW5jdGlvbihtc2dfdHlwZSwgZGF0YSwgY2FsbGJhY2ssIHRhYl9pZCkge1xuICAgIHZhciBtc2c7XG4gICAgbXNnID0ge1xuICAgICAgbWFyazogcGFyc2Vfdl9tYXJrLFxuICAgICAgdmVyc2lvbjogbXNnX3ZlcnNpb24sXG4gICAgICB0eXBlOiBtc2dfdHlwZSxcbiAgICAgIGRhdGE6IGRhdGFcbiAgICB9O1xuICAgIHJldHVybiBjaHJvbWUudGFicy5zZW5kTWVzc2FnZSh0YWJfaWQsIG1zZywgY2FsbGJhY2spO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzID0ge1xuICAgIG1hcms6IHBhcnNlX3ZfbWFyayxcbiAgICB2ZXJzaW9uOiBtc2dfdmVyc2lvbixcbiAgICB0OiB7XG4gICAgICBmb3VuZDogbXNnX3R5cGVfZm91bmQsXG4gICAgICBwbGF5aW5nOiBtc2dfdHlwZV9wbGF5aW5nLFxuICAgICAgZ2V0X2luZm86IG1zZ190eXBlX2dldF9pbmZvLFxuICAgICAgY2hlY2tfc3VwcG9ydDogbXNnX3R5cGVfY2hlY2tfc3VwcG9ydCxcbiAgICAgIHNldF90aW1lOiBtc2dfdHlwZV9zZXRfdGltZSxcbiAgICAgIGdldF9zdGF0ZTogbXNnX3R5cGVfZ2V0X3N0YXRlLFxuICAgICAgc3RhcnRfZmx1c2g6IG1zZ190eXBlX3N0YXJ0X2ZsdXNoLFxuICAgICAgZmx1c2hfZG9uZTogbXNnX3R5cGVfZmx1c2hfZG9uZSxcbiAgICAgIHBvcHVwX3JlZnJlc2g6IG1zZ190eXBlX3BvcHVwX3JlZnJlc2gsXG4gICAgICBnZXRfYWxsOiBtc2dfdHlwZV9nZXRfYWxsLFxuICAgICAgZ2V0X29uZV9maWxlOiBtc2dfdHlwZV9nZXRfb25lX2ZpbGVcbiAgICB9LFxuICAgIG9uOiBzZXRfb25fbXNnLFxuICAgIHNlbmQ6IHNlbmRfbXNnLFxuICAgIHNlbmRfdG9fY29udGVudDogc2VuZF90b19jb250ZW50XG4gIH07XG5cbn0pLmNhbGwodGhpcyk7XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPW1zZy5qcy5tYXBcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS4xMi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBjb25maWcsIG1ha2VfZmZtcGVnX21lcmdlX3NoO1xuXG4gIGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xuXG4gIG1ha2VfZmZtcGVnX21lcmdlX3NoID0gZnVuY3Rpb24oZmlsZV9saXN0LCBvdXRwdXRfZmlsZSwgc2hfZmlsZW5hbWUpIHtcbiAgICB2YXIgZmZtcGVnLCBvLCBvdXRwdXQ7XG4gICAgb3V0cHV0ID0gW107XG4gICAgbyA9IGZ1bmN0aW9uKGxpbmUpIHtcbiAgICAgIHJldHVybiBvdXRwdXQucHVzaChsaW5lKTtcbiAgICB9O1xuICAgIG8oJ0BlY2hvIG9uJyk7XG4gICAgbygnY2hjcCA2NTAwMScpO1xuICAgIG8oJycpO1xuICAgIGZmbXBlZyA9IGNvbmZpZy5tZXJnZV9mZm1wZWdfYmluO1xuICAgIG8oZmZtcGVnICsgXCIgLWkgXFxcImNvbmNhdDpcIiArIChmaWxlX2xpc3Quam9pbignfCcpKSArIFwiXFxcIiAtYyBjb3B5IFwiICsgb3V0cHV0X2ZpbGUpO1xuICAgIG8oJycpO1xuICAgIG8oJ3BhdXNlJyk7XG4gICAgbygnY21kJyk7XG4gICAgbygnJyk7XG4gICAgbyhcIjo6IGVuZCBcIiArIHNoX2ZpbGVuYW1lICsgXCI6IGZmbXBlZyBtZXJnZSBiYXQsIGdlbmVyYXRlZCBieSBwYXJzZV92LWNyeCBhdCBcIiArIChuZXcgRGF0ZSgpKSk7XG4gICAgbygnJyk7XG4gICAgcmV0dXJuIG91dHB1dC5qb2luKCdcXHJcXG4nKSArICdcXHJcXG4nO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzID0gbWFrZV9mZm1wZWdfbWVyZ2Vfc2g7XG5cbn0pLmNhbGwodGhpcyk7XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPW1lcmdlLmJhdC5qcy5tYXBcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS4xMi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBnZW5fbWVyZ2Vfc2NyaXB0LCBsb2csIG1lcmdlX2JhdCwgbWVyZ2Vfc2gsIHV0aWw7XG5cbiAgbG9nID0gcmVxdWlyZSgnLi4vbG9nJyk7XG5cbiAgdXRpbCA9IHJlcXVpcmUoJy4uL2JnL3V0aWwnKTtcblxuICBtZXJnZV9zaCA9IHJlcXVpcmUoJy4vbWVyZ2Uuc2gnKTtcblxuICBtZXJnZV9iYXQgPSByZXF1aXJlKCcuL21lcmdlLmJhdCcpO1xuXG4gIGdlbl9tZXJnZV9zY3JpcHQgPSBmdW5jdGlvbihpbmZvLCBwcmVmaXgpIHtcbiAgICB2YXIgZmlsZV9saXN0LCBpLCBtYWluX25hbWUsIG91dHB1dF9maWxlLCByYXdfbGlzdDtcbiAgICByYXdfbGlzdCA9IGluZm8udmlkZW9baW5mby5zaXplXS5maWxlO1xuICAgIG1haW5fbmFtZSA9IHJhd19saXN0WzBdLmZpbGVuYW1lLnNwbGl0KCcuJylbMF07XG4gICAgZmlsZV9saXN0ID0gKGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGosIGxlbiwgcmVzdWx0cztcbiAgICAgIHJlc3VsdHMgPSBbXTtcbiAgICAgIGZvciAoaiA9IDAsIGxlbiA9IHJhd19saXN0Lmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7XG4gICAgICAgIGkgPSByYXdfbGlzdFtqXTtcbiAgICAgICAgcmVzdWx0cy5wdXNoKGkuZmlsZW5hbWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgfSkoKTtcbiAgICBvdXRwdXRfZmlsZSA9IG1haW5fbmFtZSArIFwiLm91dC5tcDRcIjtcbiAgICByZXR1cm4gY2hyb21lLnJ1bnRpbWUuZ2V0UGxhdGZvcm1JbmZvKGZ1bmN0aW9uKHApIHtcbiAgICAgIHZhciBtYWtlX21lcmdlLCBzY3JpcHRfbmFtZSwgc2NyaXB0X3RleHQ7XG4gICAgICBsb2cuZChcInBfZGwvbWVyZ2U6IG9zIFwiICsgcC5vcyk7XG4gICAgICBpZiAocC5vcyA9PT0gJ3dpbicpIHtcbiAgICAgICAgc2NyaXB0X25hbWUgPSBcIuWQiOW5ti5cIiArIG1haW5fbmFtZSArIFwiLnBhcnNlX3YtY3J4LmJhdFwiO1xuICAgICAgICBtYWtlX21lcmdlID0gbWVyZ2VfYmF0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2NyaXB0X25hbWUgPSBcIm1lcmdlLlwiICsgbWFpbl9uYW1lICsgXCIucGFyc2Vfdi1jcnguc2hcIjtcbiAgICAgICAgbWFrZV9tZXJnZSA9IG1lcmdlX3NoO1xuICAgICAgfVxuICAgICAgc2NyaXB0X3RleHQgPSBtYWtlX21lcmdlKGZpbGVfbGlzdCwgb3V0cHV0X2ZpbGUsIHNjcmlwdF9uYW1lKTtcbiAgICAgIHV0aWwuZG93bmxvYWRfdGV4dChwcmVmaXggKyAnLycgKyBzY3JpcHRfbmFtZSwgc2NyaXB0X3RleHQpO1xuICAgICAgcmV0dXJuIGxvZy5kKFwicF9kbC9tZXJnZTogZ2VuX21lcmdlX3NjcmlwdDogZG9uZS4gXCIgKyBzY3JpcHRfbmFtZSk7XG4gICAgfSk7XG4gIH07XG5cbiAgbW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgZ2VuX21lcmdlX3NjcmlwdDogZ2VuX21lcmdlX3NjcmlwdFxuICB9O1xuXG59KS5jYWxsKHRoaXMpO1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1tZXJnZS5qcy5tYXBcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS4xMi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBjb25maWcsIG1ha2VfZmZtcGVnX21lcmdlX3NoO1xuXG4gIGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xuXG4gIG1ha2VfZmZtcGVnX21lcmdlX3NoID0gZnVuY3Rpb24oZmlsZV9saXN0LCBvdXRwdXRfZmlsZSwgc2hfZmlsZW5hbWUpIHtcbiAgICB2YXIgZmZtcGVnLCBpLCBqLCBsZW4sIG8sIG91dHB1dDtcbiAgICBvdXRwdXQgPSBbXTtcbiAgICBvID0gZnVuY3Rpb24obGluZSkge1xuICAgICAgcmV0dXJuIG91dHB1dC5wdXNoKGxpbmUpO1xuICAgIH07XG4gICAgbygnIyEvYmluL3NoJyk7XG4gICAgbyhcIiMgXCIgKyBzaF9maWxlbmFtZSArIFwiOiBmZm1wZWcgbWVyZ2Ugc2gsIGdlbmVyYXRlZCBieSBwYXJzZV92LWNyeCBhdCBcIiArIChuZXcgRGF0ZSgpKSk7XG4gICAgbygnJyk7XG4gICAgbygnZmlsZV9saXN0PVwiXFxcXCcpO1xuICAgIGZvciAoaiA9IDAsIGxlbiA9IGZpbGVfbGlzdC5sZW5ndGg7IGogPCBsZW47IGorKykge1xuICAgICAgaSA9IGZpbGVfbGlzdFtqXTtcbiAgICAgIG8oaSArIFwiXFxcXFwiKTtcbiAgICAgIG8oJ3xcXFxcJyk7XG4gICAgfVxuICAgIG91dHB1dC5wb3AoKTtcbiAgICBvKCdcIicpO1xuICAgIG8oXCJvdXRwdXRfZmlsZT1cXFwiXCIgKyBvdXRwdXRfZmlsZSArIFwiXFxcIlwiKTtcbiAgICBvKCcnKTtcbiAgICBmZm1wZWcgPSBjb25maWcubWVyZ2VfZmZtcGVnX2JpbjtcbiAgICBvKFwiZWNobyBcXFwiLT4gXCIgKyBmZm1wZWcgKyBcIiAtaSBcXFxcXFxcImNvbmNhdDoke2ZpbGVfbGlzdH1cXFxcXFxcIiAtYyBjb3B5ICR7b3V0cHV0X2ZpbGV9XFxcIlwiKTtcbiAgICBvKGZmbXBlZyArIFwiIC1pIFxcXCJjb25jYXQ6JHtmaWxlX2xpc3R9XFxcIiAtYyBjb3B5ICR7b3V0cHV0X2ZpbGV9XCIpO1xuICAgIG8oJycpO1xuICAgIG8oXCIjIGVuZCBcIiArIHNoX2ZpbGVuYW1lKTtcbiAgICBvKCcnKTtcbiAgICByZXR1cm4gb3V0cHV0LmpvaW4oJ1xcbicpICsgJ1xcbic7XG4gIH07XG5cbiAgbW9kdWxlLmV4cG9ydHMgPSBtYWtlX2ZmbXBlZ19tZXJnZV9zaDtcblxufSkuY2FsbCh0aGlzKTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9bWVyZ2Uuc2guanMubWFwXG4iXX0=
