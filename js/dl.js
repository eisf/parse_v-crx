(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.pv_dl = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var create_dl_ui, dl_init, get_all_info, log, msg, render_one_tab, render_page;

  log = require('./log');

  msg = require('./msg');

  get_all_info = function() {
    return msg.send(msg.t.get_all, null, function(info) {
      log.d("dl: get_all: result = " + (JSON.stringify(info)));
      return render_page(info);
    });
  };

  render_page = function(info) {
    var div, i, results, v;
    if (info === null) {
      return;
    }
    $('#main_place_holder').remove();
    div = $('#dl_main_ui');
    results = [];
    for (i in info) {
      v = info[i];
      results.push(render_one_tab(i, v, div));
    }
    return results;
  };

  render_one_tab = function(tab_id, one, host) {
    var a, before, div, f, filename, h, i, j, len, li, ol, p, time_s;
    div = $("<div id=\"tab_id_" + tab_id + "\" ></div>");
    host.append(div);
    h = $('<h2></h2>');
    h.text("id " + tab_id + " : " + one.title);
    div.append(h);
    p = $('<p></p>');
    p.text("[" + one.site + "] " + one.url);
    div.append(p);
    h = $('<h3></h3>');
    h.text("视频: " + one.title_video + "_" + one.title_sub + " [ " + one.size + " ] 时长 " + (Math.round(one.max_time_s / 60)) + " 分钟 (" + one.max_time_s + " 秒) ");
    div.append(h);
    f = one.video[one.size].file;
    p = $('<p></p>');
    p.text("文件列表 (共 " + f.length + " 个分段)");
    div.append(p);
    ol = $('<ol></ol>');
    div.append(ol);
    for (j = 0, len = f.length; j < len; j++) {
      i = f[j];
      li = $('<li></li>');
      ol.append(li);
      time_s = i.time_s, before = i.before, filename = i.filename;
      p = $('<p></p>');
      p.text("[ " + (Math.round(time_s / 60)) + " 分钟 (" + time_s + " 秒) ] " + filename);
      li.append(p);
      a = $('<a></a>');
      a.text(before);
      a.attr('href', before);
      li.append(a);
    }
    return create_dl_ui(div, one, tab_id);
  };

  create_dl_ui = function(div, info, tab_id) {
    var b, count, dl_dir_prefix, download_next, download_one_file, f, get_one_final_url, i_max, ll, pre, start_download;
    div.append($('<h3>简单下载功能</h3>'));
    b = $('<button type="button" >下载全部分段</button>');
    div.append(b);
    pre = $('<pre></pre>');
    div.append(pre);
    ll = function(text) {
      return pre.text(pre.text() + ':: ' + text + '\n');
    };
    dl_dir_prefix = 'parse_v-crx-dl';
    f = info.video[info.size].file;
    count = {
      i: 0
    };
    i_max = f.length;
    b.on('click', function() {
      ll("开始下载共 " + i_max + " 个文件 .. . ");
      return start_download();
    });
    start_download = function() {
      if (count.i >= i_max) {
        return ll("所有文件下载完毕 ! ");
      }
      ll("下载第 " + (count.i + 1) + " 个文件 ");
      return get_one_final_url(tab_id, f[count.i]);
    };
    get_one_final_url = function(tab_id, raw) {
      return msg.send(msg.t.get_one_file, {
        tab_id: tab_id,
        raw: raw
      }, function(result) {
        var file_path;
        log.d("FIXME: dl: get_one_final_url: result = " + (JSON.stringify(result)));
        file_path = dl_dir_prefix + '/' + raw.filename;
        return download_one_file(result.url, file_path);
      });
    };
    download_one_file = function(file_url, file_path) {
      return chrome.downloads.download({
        url: file_url,
        filename: file_path,
        conflictAction: 'uniquify'
      }, function(download_id) {
        ll("文件 " + file_path + " 已开始下载, 等待下载完成 .. . ");
        log.d("download start: id == " + info.id + ", file_path = " + file_path + ", url == " + file_url + " ");
        return chrome.downloads.onChanged.addListener(function(info) {
          if (info.id === download_id) {
            log.d("download changed: id == " + info.id + ", state == " + (JSON.stringify(info.state)) + " ");
            if ((info.state != null) && (info.state.current === 'complete')) {
              ll("[ OK ] 文件 " + file_path + " 下载完成 ! ");
              return download_next();
            }
          }
        });
      });
    };
    return download_next = function() {
      count.i += 1;
      return start_download();
    };
  };

  dl_init = function() {
    log.d('dl: init ');
    return get_all_info();
  };

  dl_init();

}).call(this);



},{"./log":2,"./msg":3}],2:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var log_p;

  log_p = function(text) {
    return console.log(module.exports.prefix + text);
  };

  module.exports = {
    prefix: 'parse_v-crx: ',
    d: function(text) {
      return log_p('DEBUG: ' + text);
    },
    c: function(text) {
      return log_p('content script: ' + text);
    }
  };

}).call(this);



},{}],3:[function(require,module,exports){
// Generated by CoffeeScript 1.12.3
(function() {
  var msg_type_check_support, msg_type_flush_done, msg_type_found, msg_type_get_all, msg_type_get_info, msg_type_get_one_file, msg_type_get_state, msg_type_playing, msg_type_set_time, msg_type_start_flush, msg_version, parse_v_mark, send_msg, send_to_content, set_on_msg;

  parse_v_mark = 'uuid=ec9680e6-da5e-4971-ac5f-25d971bf6366';

  msg_version = '0.1.0-1';

  msg_type_found = 'content_found';

  msg_type_playing = 'content_playing';

  msg_type_get_info = 'content_get_info';

  msg_type_check_support = 'content_check_support';

  msg_type_set_time = 'content_set_time';

  msg_type_get_state = 'popup_get_state';

  msg_type_start_flush = 'popup_start_flush';

  msg_type_flush_done = 'popup_flush_done';

  msg_type_get_all = 'dl_get_all';

  msg_type_get_one_file = 'dl_get_one_file';

  set_on_msg = function(callback) {
    return chrome.runtime.onMessage.addListener(function(msg, sender, send_res) {
      var e;
      try {
        if (!((msg.mark === parse_v_mark) && (msg.version === msg_version))) {
          return;
        }
      } catch (error) {
        e = error;
        return;
      }
      callback({
        mark: msg.mark,
        version: msg.version,
        type: msg.type,
        data: msg.data,
        sender: sender,
        callback: send_res
      });
      return true;
    });
  };

  send_msg = function(msg_type, data, callback) {
    var msg;
    msg = {
      mark: parse_v_mark,
      version: msg_version,
      type: msg_type,
      data: data
    };
    return chrome.runtime.sendMessage(null, msg, callback);
  };

  send_to_content = function(msg_type, data, callback, tab_id) {
    var msg;
    msg = {
      mark: parse_v_mark,
      version: msg_version,
      type: msg_type,
      data: data
    };
    return chrome.tabs.sendMessage(tab_id, msg, callback);
  };

  module.exports = {
    mark: parse_v_mark,
    version: msg_version,
    t: {
      found: msg_type_found,
      playing: msg_type_playing,
      get_info: msg_type_get_info,
      check_support: msg_type_check_support,
      set_time: msg_type_set_time,
      get_state: msg_type_get_state,
      start_flush: msg_type_start_flush,
      flush_done: msg_type_flush_done,
      get_all: msg_type_get_all,
      get_one_file: msg_type_get_one_file
    },
    on: set_on_msg,
    send: send_msg,
    send_to_content: send_to_content
  };

}).call(this);



},{}]},{},[1])(1)
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJkaXN0L3MvZGwuanMiLCJkaXN0L3MvbG9nLmpzIiwiZGlzdC9zL21zZy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzFJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNyQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjEyLjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIGNyZWF0ZV9kbF91aSwgZGxfaW5pdCwgZ2V0X2FsbF9pbmZvLCBsb2csIG1zZywgcmVuZGVyX29uZV90YWIsIHJlbmRlcl9wYWdlO1xuXG4gIGxvZyA9IHJlcXVpcmUoJy4vbG9nJyk7XG5cbiAgbXNnID0gcmVxdWlyZSgnLi9tc2cnKTtcblxuICBnZXRfYWxsX2luZm8gPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbXNnLnNlbmQobXNnLnQuZ2V0X2FsbCwgbnVsbCwgZnVuY3Rpb24oaW5mbykge1xuICAgICAgbG9nLmQoXCJkbDogZ2V0X2FsbDogcmVzdWx0ID0gXCIgKyAoSlNPTi5zdHJpbmdpZnkoaW5mbykpKTtcbiAgICAgIHJldHVybiByZW5kZXJfcGFnZShpbmZvKTtcbiAgICB9KTtcbiAgfTtcblxuICByZW5kZXJfcGFnZSA9IGZ1bmN0aW9uKGluZm8pIHtcbiAgICB2YXIgZGl2LCBpLCByZXN1bHRzLCB2O1xuICAgIGlmIChpbmZvID09PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgICQoJyNtYWluX3BsYWNlX2hvbGRlcicpLnJlbW92ZSgpO1xuICAgIGRpdiA9ICQoJyNkbF9tYWluX3VpJyk7XG4gICAgcmVzdWx0cyA9IFtdO1xuICAgIGZvciAoaSBpbiBpbmZvKSB7XG4gICAgICB2ID0gaW5mb1tpXTtcbiAgICAgIHJlc3VsdHMucHVzaChyZW5kZXJfb25lX3RhYihpLCB2LCBkaXYpKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH07XG5cbiAgcmVuZGVyX29uZV90YWIgPSBmdW5jdGlvbih0YWJfaWQsIG9uZSwgaG9zdCkge1xuICAgIHZhciBhLCBiZWZvcmUsIGRpdiwgZiwgZmlsZW5hbWUsIGgsIGksIGosIGxlbiwgbGksIG9sLCBwLCB0aW1lX3M7XG4gICAgZGl2ID0gJChcIjxkaXYgaWQ9XFxcInRhYl9pZF9cIiArIHRhYl9pZCArIFwiXFxcIiA+PC9kaXY+XCIpO1xuICAgIGhvc3QuYXBwZW5kKGRpdik7XG4gICAgaCA9ICQoJzxoMj48L2gyPicpO1xuICAgIGgudGV4dChcImlkIFwiICsgdGFiX2lkICsgXCIgOiBcIiArIG9uZS50aXRsZSk7XG4gICAgZGl2LmFwcGVuZChoKTtcbiAgICBwID0gJCgnPHA+PC9wPicpO1xuICAgIHAudGV4dChcIltcIiArIG9uZS5zaXRlICsgXCJdIFwiICsgb25lLnVybCk7XG4gICAgZGl2LmFwcGVuZChwKTtcbiAgICBoID0gJCgnPGgzPjwvaDM+Jyk7XG4gICAgaC50ZXh0KFwi6KeG6aKROiBcIiArIG9uZS50aXRsZV92aWRlbyArIFwiX1wiICsgb25lLnRpdGxlX3N1YiArIFwiIFsgXCIgKyBvbmUuc2l6ZSArIFwiIF0g5pe26ZW/IFwiICsgKE1hdGgucm91bmQob25lLm1heF90aW1lX3MgLyA2MCkpICsgXCIg5YiG6ZKfIChcIiArIG9uZS5tYXhfdGltZV9zICsgXCIg56eSKSBcIik7XG4gICAgZGl2LmFwcGVuZChoKTtcbiAgICBmID0gb25lLnZpZGVvW29uZS5zaXplXS5maWxlO1xuICAgIHAgPSAkKCc8cD48L3A+Jyk7XG4gICAgcC50ZXh0KFwi5paH5Lu25YiX6KGoICjlhbEgXCIgKyBmLmxlbmd0aCArIFwiIOS4quWIhuautSlcIik7XG4gICAgZGl2LmFwcGVuZChwKTtcbiAgICBvbCA9ICQoJzxvbD48L29sPicpO1xuICAgIGRpdi5hcHBlbmQob2wpO1xuICAgIGZvciAoaiA9IDAsIGxlbiA9IGYubGVuZ3RoOyBqIDwgbGVuOyBqKyspIHtcbiAgICAgIGkgPSBmW2pdO1xuICAgICAgbGkgPSAkKCc8bGk+PC9saT4nKTtcbiAgICAgIG9sLmFwcGVuZChsaSk7XG4gICAgICB0aW1lX3MgPSBpLnRpbWVfcywgYmVmb3JlID0gaS5iZWZvcmUsIGZpbGVuYW1lID0gaS5maWxlbmFtZTtcbiAgICAgIHAgPSAkKCc8cD48L3A+Jyk7XG4gICAgICBwLnRleHQoXCJbIFwiICsgKE1hdGgucm91bmQodGltZV9zIC8gNjApKSArIFwiIOWIhumSnyAoXCIgKyB0aW1lX3MgKyBcIiDnp5IpIF0gXCIgKyBmaWxlbmFtZSk7XG4gICAgICBsaS5hcHBlbmQocCk7XG4gICAgICBhID0gJCgnPGE+PC9hPicpO1xuICAgICAgYS50ZXh0KGJlZm9yZSk7XG4gICAgICBhLmF0dHIoJ2hyZWYnLCBiZWZvcmUpO1xuICAgICAgbGkuYXBwZW5kKGEpO1xuICAgIH1cbiAgICByZXR1cm4gY3JlYXRlX2RsX3VpKGRpdiwgb25lLCB0YWJfaWQpO1xuICB9O1xuXG4gIGNyZWF0ZV9kbF91aSA9IGZ1bmN0aW9uKGRpdiwgaW5mbywgdGFiX2lkKSB7XG4gICAgdmFyIGIsIGNvdW50LCBkbF9kaXJfcHJlZml4LCBkb3dubG9hZF9uZXh0LCBkb3dubG9hZF9vbmVfZmlsZSwgZiwgZ2V0X29uZV9maW5hbF91cmwsIGlfbWF4LCBsbCwgcHJlLCBzdGFydF9kb3dubG9hZDtcbiAgICBkaXYuYXBwZW5kKCQoJzxoMz7nroDljZXkuIvovb3lip/og708L2gzPicpKTtcbiAgICBiID0gJCgnPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgPuS4i+i9veWFqOmDqOWIhuautTwvYnV0dG9uPicpO1xuICAgIGRpdi5hcHBlbmQoYik7XG4gICAgcHJlID0gJCgnPHByZT48L3ByZT4nKTtcbiAgICBkaXYuYXBwZW5kKHByZSk7XG4gICAgbGwgPSBmdW5jdGlvbih0ZXh0KSB7XG4gICAgICByZXR1cm4gcHJlLnRleHQocHJlLnRleHQoKSArICc6OiAnICsgdGV4dCArICdcXG4nKTtcbiAgICB9O1xuICAgIGRsX2Rpcl9wcmVmaXggPSAncGFyc2Vfdi1jcngtZGwnO1xuICAgIGYgPSBpbmZvLnZpZGVvW2luZm8uc2l6ZV0uZmlsZTtcbiAgICBjb3VudCA9IHtcbiAgICAgIGk6IDBcbiAgICB9O1xuICAgIGlfbWF4ID0gZi5sZW5ndGg7XG4gICAgYi5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgICAgIGxsKFwi5byA5aeL5LiL6L295YWxIFwiICsgaV9tYXggKyBcIiDkuKrmlofku7YgLi4gLiBcIik7XG4gICAgICByZXR1cm4gc3RhcnRfZG93bmxvYWQoKTtcbiAgICB9KTtcbiAgICBzdGFydF9kb3dubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKGNvdW50LmkgPj0gaV9tYXgpIHtcbiAgICAgICAgcmV0dXJuIGxsKFwi5omA5pyJ5paH5Lu25LiL6L295a6M5q+VICEgXCIpO1xuICAgICAgfVxuICAgICAgbGwoXCLkuIvovb3nrKwgXCIgKyAoY291bnQuaSArIDEpICsgXCIg5Liq5paH5Lu2IFwiKTtcbiAgICAgIHJldHVybiBnZXRfb25lX2ZpbmFsX3VybCh0YWJfaWQsIGZbY291bnQuaV0pO1xuICAgIH07XG4gICAgZ2V0X29uZV9maW5hbF91cmwgPSBmdW5jdGlvbih0YWJfaWQsIHJhdykge1xuICAgICAgcmV0dXJuIG1zZy5zZW5kKG1zZy50LmdldF9vbmVfZmlsZSwge1xuICAgICAgICB0YWJfaWQ6IHRhYl9pZCxcbiAgICAgICAgcmF3OiByYXdcbiAgICAgIH0sIGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICB2YXIgZmlsZV9wYXRoO1xuICAgICAgICBsb2cuZChcIkZJWE1FOiBkbDogZ2V0X29uZV9maW5hbF91cmw6IHJlc3VsdCA9IFwiICsgKEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpKTtcbiAgICAgICAgZmlsZV9wYXRoID0gZGxfZGlyX3ByZWZpeCArICcvJyArIHJhdy5maWxlbmFtZTtcbiAgICAgICAgcmV0dXJuIGRvd25sb2FkX29uZV9maWxlKHJlc3VsdC51cmwsIGZpbGVfcGF0aCk7XG4gICAgICB9KTtcbiAgICB9O1xuICAgIGRvd25sb2FkX29uZV9maWxlID0gZnVuY3Rpb24oZmlsZV91cmwsIGZpbGVfcGF0aCkge1xuICAgICAgcmV0dXJuIGNocm9tZS5kb3dubG9hZHMuZG93bmxvYWQoe1xuICAgICAgICB1cmw6IGZpbGVfdXJsLFxuICAgICAgICBmaWxlbmFtZTogZmlsZV9wYXRoLFxuICAgICAgICBjb25mbGljdEFjdGlvbjogJ3VuaXF1aWZ5J1xuICAgICAgfSwgZnVuY3Rpb24oZG93bmxvYWRfaWQpIHtcbiAgICAgICAgbGwoXCLmlofku7YgXCIgKyBmaWxlX3BhdGggKyBcIiDlt7LlvIDlp4vkuIvovb0sIOetieW+heS4i+i9veWujOaIkCAuLiAuIFwiKTtcbiAgICAgICAgbG9nLmQoXCJkb3dubG9hZCBzdGFydDogaWQgPT0gXCIgKyBpbmZvLmlkICsgXCIsIGZpbGVfcGF0aCA9IFwiICsgZmlsZV9wYXRoICsgXCIsIHVybCA9PSBcIiArIGZpbGVfdXJsICsgXCIgXCIpO1xuICAgICAgICByZXR1cm4gY2hyb21lLmRvd25sb2Fkcy5vbkNoYW5nZWQuYWRkTGlzdGVuZXIoZnVuY3Rpb24oaW5mbykge1xuICAgICAgICAgIGlmIChpbmZvLmlkID09PSBkb3dubG9hZF9pZCkge1xuICAgICAgICAgICAgbG9nLmQoXCJkb3dubG9hZCBjaGFuZ2VkOiBpZCA9PSBcIiArIGluZm8uaWQgKyBcIiwgc3RhdGUgPT0gXCIgKyAoSlNPTi5zdHJpbmdpZnkoaW5mby5zdGF0ZSkpICsgXCIgXCIpO1xuICAgICAgICAgICAgaWYgKChpbmZvLnN0YXRlICE9IG51bGwpICYmIChpbmZvLnN0YXRlLmN1cnJlbnQgPT09ICdjb21wbGV0ZScpKSB7XG4gICAgICAgICAgICAgIGxsKFwiWyBPSyBdIOaWh+S7tiBcIiArIGZpbGVfcGF0aCArIFwiIOS4i+i9veWujOaIkCAhIFwiKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGRvd25sb2FkX25leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfTtcbiAgICByZXR1cm4gZG93bmxvYWRfbmV4dCA9IGZ1bmN0aW9uKCkge1xuICAgICAgY291bnQuaSArPSAxO1xuICAgICAgcmV0dXJuIHN0YXJ0X2Rvd25sb2FkKCk7XG4gICAgfTtcbiAgfTtcblxuICBkbF9pbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgbG9nLmQoJ2RsOiBpbml0ICcpO1xuICAgIHJldHVybiBnZXRfYWxsX2luZm8oKTtcbiAgfTtcblxuICBkbF9pbml0KCk7XG5cbn0pLmNhbGwodGhpcyk7XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWRsLmpzLm1hcFxuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjEyLjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIGxvZ19wO1xuXG4gIGxvZ19wID0gZnVuY3Rpb24odGV4dCkge1xuICAgIHJldHVybiBjb25zb2xlLmxvZyhtb2R1bGUuZXhwb3J0cy5wcmVmaXggKyB0ZXh0KTtcbiAgfTtcblxuICBtb2R1bGUuZXhwb3J0cyA9IHtcbiAgICBwcmVmaXg6ICdwYXJzZV92LWNyeDogJyxcbiAgICBkOiBmdW5jdGlvbih0ZXh0KSB7XG4gICAgICByZXR1cm4gbG9nX3AoJ0RFQlVHOiAnICsgdGV4dCk7XG4gICAgfSxcbiAgICBjOiBmdW5jdGlvbih0ZXh0KSB7XG4gICAgICByZXR1cm4gbG9nX3AoJ2NvbnRlbnQgc2NyaXB0OiAnICsgdGV4dCk7XG4gICAgfVxuICB9O1xuXG59KS5jYWxsKHRoaXMpO1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1sb2cuanMubWFwXG4iLCIvLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuMTIuM1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgbXNnX3R5cGVfY2hlY2tfc3VwcG9ydCwgbXNnX3R5cGVfZmx1c2hfZG9uZSwgbXNnX3R5cGVfZm91bmQsIG1zZ190eXBlX2dldF9hbGwsIG1zZ190eXBlX2dldF9pbmZvLCBtc2dfdHlwZV9nZXRfb25lX2ZpbGUsIG1zZ190eXBlX2dldF9zdGF0ZSwgbXNnX3R5cGVfcGxheWluZywgbXNnX3R5cGVfc2V0X3RpbWUsIG1zZ190eXBlX3N0YXJ0X2ZsdXNoLCBtc2dfdmVyc2lvbiwgcGFyc2Vfdl9tYXJrLCBzZW5kX21zZywgc2VuZF90b19jb250ZW50LCBzZXRfb25fbXNnO1xuXG4gIHBhcnNlX3ZfbWFyayA9ICd1dWlkPWVjOTY4MGU2LWRhNWUtNDk3MS1hYzVmLTI1ZDk3MWJmNjM2Nic7XG5cbiAgbXNnX3ZlcnNpb24gPSAnMC4xLjAtMSc7XG5cbiAgbXNnX3R5cGVfZm91bmQgPSAnY29udGVudF9mb3VuZCc7XG5cbiAgbXNnX3R5cGVfcGxheWluZyA9ICdjb250ZW50X3BsYXlpbmcnO1xuXG4gIG1zZ190eXBlX2dldF9pbmZvID0gJ2NvbnRlbnRfZ2V0X2luZm8nO1xuXG4gIG1zZ190eXBlX2NoZWNrX3N1cHBvcnQgPSAnY29udGVudF9jaGVja19zdXBwb3J0JztcblxuICBtc2dfdHlwZV9zZXRfdGltZSA9ICdjb250ZW50X3NldF90aW1lJztcblxuICBtc2dfdHlwZV9nZXRfc3RhdGUgPSAncG9wdXBfZ2V0X3N0YXRlJztcblxuICBtc2dfdHlwZV9zdGFydF9mbHVzaCA9ICdwb3B1cF9zdGFydF9mbHVzaCc7XG5cbiAgbXNnX3R5cGVfZmx1c2hfZG9uZSA9ICdwb3B1cF9mbHVzaF9kb25lJztcblxuICBtc2dfdHlwZV9nZXRfYWxsID0gJ2RsX2dldF9hbGwnO1xuXG4gIG1zZ190eXBlX2dldF9vbmVfZmlsZSA9ICdkbF9nZXRfb25lX2ZpbGUnO1xuXG4gIHNldF9vbl9tc2cgPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgIHJldHVybiBjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UuYWRkTGlzdGVuZXIoZnVuY3Rpb24obXNnLCBzZW5kZXIsIHNlbmRfcmVzKSB7XG4gICAgICB2YXIgZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmICghKChtc2cubWFyayA9PT0gcGFyc2Vfdl9tYXJrKSAmJiAobXNnLnZlcnNpb24gPT09IG1zZ192ZXJzaW9uKSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGUgPSBlcnJvcjtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY2FsbGJhY2soe1xuICAgICAgICBtYXJrOiBtc2cubWFyayxcbiAgICAgICAgdmVyc2lvbjogbXNnLnZlcnNpb24sXG4gICAgICAgIHR5cGU6IG1zZy50eXBlLFxuICAgICAgICBkYXRhOiBtc2cuZGF0YSxcbiAgICAgICAgc2VuZGVyOiBzZW5kZXIsXG4gICAgICAgIGNhbGxiYWNrOiBzZW5kX3Jlc1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgfTtcblxuICBzZW5kX21zZyA9IGZ1bmN0aW9uKG1zZ190eXBlLCBkYXRhLCBjYWxsYmFjaykge1xuICAgIHZhciBtc2c7XG4gICAgbXNnID0ge1xuICAgICAgbWFyazogcGFyc2Vfdl9tYXJrLFxuICAgICAgdmVyc2lvbjogbXNnX3ZlcnNpb24sXG4gICAgICB0eXBlOiBtc2dfdHlwZSxcbiAgICAgIGRhdGE6IGRhdGFcbiAgICB9O1xuICAgIHJldHVybiBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZShudWxsLCBtc2csIGNhbGxiYWNrKTtcbiAgfTtcblxuICBzZW5kX3RvX2NvbnRlbnQgPSBmdW5jdGlvbihtc2dfdHlwZSwgZGF0YSwgY2FsbGJhY2ssIHRhYl9pZCkge1xuICAgIHZhciBtc2c7XG4gICAgbXNnID0ge1xuICAgICAgbWFyazogcGFyc2Vfdl9tYXJrLFxuICAgICAgdmVyc2lvbjogbXNnX3ZlcnNpb24sXG4gICAgICB0eXBlOiBtc2dfdHlwZSxcbiAgICAgIGRhdGE6IGRhdGFcbiAgICB9O1xuICAgIHJldHVybiBjaHJvbWUudGFicy5zZW5kTWVzc2FnZSh0YWJfaWQsIG1zZywgY2FsbGJhY2spO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzID0ge1xuICAgIG1hcms6IHBhcnNlX3ZfbWFyayxcbiAgICB2ZXJzaW9uOiBtc2dfdmVyc2lvbixcbiAgICB0OiB7XG4gICAgICBmb3VuZDogbXNnX3R5cGVfZm91bmQsXG4gICAgICBwbGF5aW5nOiBtc2dfdHlwZV9wbGF5aW5nLFxuICAgICAgZ2V0X2luZm86IG1zZ190eXBlX2dldF9pbmZvLFxuICAgICAgY2hlY2tfc3VwcG9ydDogbXNnX3R5cGVfY2hlY2tfc3VwcG9ydCxcbiAgICAgIHNldF90aW1lOiBtc2dfdHlwZV9zZXRfdGltZSxcbiAgICAgIGdldF9zdGF0ZTogbXNnX3R5cGVfZ2V0X3N0YXRlLFxuICAgICAgc3RhcnRfZmx1c2g6IG1zZ190eXBlX3N0YXJ0X2ZsdXNoLFxuICAgICAgZmx1c2hfZG9uZTogbXNnX3R5cGVfZmx1c2hfZG9uZSxcbiAgICAgIGdldF9hbGw6IG1zZ190eXBlX2dldF9hbGwsXG4gICAgICBnZXRfb25lX2ZpbGU6IG1zZ190eXBlX2dldF9vbmVfZmlsZVxuICAgIH0sXG4gICAgb246IHNldF9vbl9tc2csXG4gICAgc2VuZDogc2VuZF9tc2csXG4gICAgc2VuZF90b19jb250ZW50OiBzZW5kX3RvX2NvbnRlbnRcbiAgfTtcblxufSkuY2FsbCh0aGlzKTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9bXNnLmpzLm1hcFxuIl19
